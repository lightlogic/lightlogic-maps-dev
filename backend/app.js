const express = require("express");
const bodyParser = require("body-parser");
const mongoose = require("mongoose");

const Feature = require("./models/feature");

const app = express();

mongoose
  .connect(
    "mongodb+srv://gero102:6wghwSh.7HtG-4brr@cluster0.65rz0.mongodb.net/lightlogicmaps?retryWrites=true"
  )
  .then(() => {
    console.log("Connected to the database.");
  })
  .catch(() => {
    console.log("Connection failed.");
  });

// body-parser acts as an express middleware
// it parses the body of the request for json data and make it available as such in the response
app.use(bodyParser.json());
// body-parser can also parses the body for url encoded data and make it available
app.use(bodyParser.urlencoded({ extended: false }));

app.use((req, res, next) => {
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader(
    "Access-Control-Allow-Headers",
    "Origin, X-Requested-With, Content-Type, Accept"
  );
  res.setHeader(
    "Access-Control-Allow-Methods",
    "GET, POST, PATCH, DELETE, OPTIONS"
  );
  next();
});

//TODO #3 post new ol/feature from the frontend to store them into mongoDB
app.post("/api/features", (req, res, next) => {
  // req.body is a new object added to the request by body-parser
  const feature = new Feature({
    //id: req.body.id,
    uri: req.body.uri,
    description: req.body.description,
    wktGeometry: req.body.wktGeometry,
    projection: req.body.projection,
  });
  feature.save();
  res.status(201).json({
    message: "Feature added sucessfully",
  });
});

//TODO #2 store ol/features in mongoDB
app.get("/api/features", (req, res, next) => {
  const features = [
    {
      id: "2284",
      uri: "https://ld.geo.admin.ch/boundaries/municipality/2284:2020",
      description: "Mont-Vully",
      wktGeometry:
        "POLYGON((7.150708188614 46.977532980584,7.1484801053854 46.977400451787,7.1462781349808 46.977716210601,7.1422597744043 46.975487062939,7.1391027356086 46.973786456931,7.1385449722264 46.973389990641,7.1385006463153 46.973367566038,7.1382995922754 46.97324226269,7.1342817515426 46.970972185876,7.1253273558714 46.965940837471,7.1257111570275 46.96574665996,7.1275623902945 46.964707317267,7.1273854656878 46.96456056157,7.1228196732827 46.961018601054,7.1187782130011 46.9590497296,7.1183600352198 46.958916248672,7.1185303562115 46.95866615283,7.1186665959875 46.95841379112,7.1187895213483 46.958100055683,7.1188550124187 46.957726509593,7.1188530251416 46.957402203284,7.1188170476484 46.957170745029,7.1184210082054 46.955076858994,7.1163705728418 46.947136494339,7.1103444453893 46.944080533559,7.0987853340745 46.938217186083,7.0882955218492 46.932893615841,7.0835914840235 46.930505740837,7.0721751616187 46.924708876767,7.0599158926415 46.936526172877,7.059438743177 46.93698607054,7.0585855294219 46.937914888079,7.0582297494596 46.938257795948,7.0578794306171 46.93861008727,7.0581554702264 46.938721638317,7.0581050661794 46.938775520839,7.0581373839672 46.938787985825,7.0581199366533 46.93881291212,7.0584232920638 46.938959578972,7.0589395929558 46.939254037637,7.0588937999885 46.93929203665,7.0592265592011 46.939763675437,7.059558550893 46.9401798884,7.0599441565244 46.940648540822,7.060185687124 46.940876045436,7.0604068805004 46.941112601139,7.0606170228536 46.941324146638,7.0606498153389 46.941367353882,7.0606668912478 46.941360112975,7.0609837625468 46.941772302399,7.0610346269658 46.941753243176,7.0610652456874 46.941795150034,7.0612051982169 46.942078008591,7.0612934535604 46.942272227465,7.0613142564618 46.942570287646,7.0613300998133 46.942973452608,7.0613667379677 46.943594383443,7.0613831974724 46.943996414705,7.061365539322 46.944235383616,7.0613081183663 46.944590518937,7.0612864174937 46.944687798709,7.0612270045594 46.944934039456,7.0611898905861 46.945016752123,7.0611734414488 46.945160880928,7.0612051705463 46.945492844339,7.0611332608182 46.945865000166,7.0610782057418 46.946182183008,7.0610026730796 46.946432193282,7.0608760800683 46.946788797369,7.0607954123956 46.947082181493,7.0606284537496 46.947067180303,7.0606540879981 46.94711314109,7.0606568522744 46.947244919877,7.0604895315367 46.948215968778,7.0604259286639 46.948517358665,7.0604192573782 46.948625010073,7.060448061785 46.948731339717,7.0604911591405 46.948841224838,7.0606251771608 46.949022563576,7.0605580411471 46.949117331488,7.0604715363933 46.949555283816,7.0604322658673 46.949666065557,7.0595418017274 46.951498033314,7.0594421140763 46.951699644365,7.0593589573665 46.951792828254,7.0592258751425 46.95184986549,7.0591894087474 46.951972168855,7.0591496502355 46.952225352372,7.0591027530397 46.952447739638,7.0590967679464 46.952513733821,7.0591057110021 46.952586445356,7.0591232647432 46.952649020843,7.0590971618477 46.952736188264,7.0590751197026 46.952843518587,7.0589258095598 46.953132310303,7.0588810382258 46.953239924828,7.0588738161461 46.953332102368,7.0588915223759 46.953336119159,7.0589159887746 46.95336867344,7.0587359724384 46.953800466346,7.0586421808923 46.953873645721,7.0580352689831 46.954056297892,7.0572776353027 46.954315443249,7.0571337378599 46.954377299947,7.0570113830888 46.954457848658,7.056922399861 46.954556319409,7.0564947913843 46.955163138635,7.0564562563799 46.955224357458,7.0565851665878 46.955293332684,7.0596136856112 46.955814106462,7.0586496072118 46.958270108209,7.0584022894916 46.958174475108,7.0583757226747 46.95820617369,7.0582698554494 46.958237304638,7.0574142622908 46.959563064298,7.0575103744329 46.95964541058,7.0591273733716 46.960123585264,7.0591072702089 46.960160837568,7.0590011319271 46.960197286741,7.0575488021412 46.962144771146,7.058977941449 46.962798537739,7.0596364171691 46.963085165559,7.0579037884953 46.965410131271,7.0612973173474 46.96676645053,7.0612604657568 46.967131378546,7.0611014397253 46.967585113237,7.0609585051365 46.967855319092,7.0607763617711 46.968099859825,7.060756477208 46.968247833358,7.06063576434 46.968368971074,7.0602352993548 46.968737293856,7.0630443661533 46.971108647092,7.0609676012265 46.97275241672,7.0606072569949 46.973013256411,7.0602707913076 46.973241982327,7.0599268570145 46.97343001277,7.0595785852501 46.973599238984,7.058984680446 46.973844006579,7.0569321832629 46.974581726878,7.0563624021431 46.974794549684,7.0561921237574 46.974864412612,7.0560436284613 46.974936507084,7.0552846122851 46.975348475044,7.0544481006981 46.975844204235,7.0533020566553 46.976505914292,7.0523651054518 46.977037169307,7.0521389189694 46.977128425796,7.0516999460741 46.9772750131,7.0512532514777 46.977380453065,7.0492225581835 46.977797597863,7.0434001175814 46.978924187257,7.0403441124916 46.979523027582,7.0401632971652 46.97984486544,7.0405220556234 46.979774873434,7.0505530938972 46.977817202465,7.0512705868267 46.977670574541,7.0516752484396 46.97757352641,7.0577807667951 46.976874116391,7.0860525539487 46.976288215544,7.0861785587032 46.976312891458,7.0865661005322 46.976377142936,7.0869567138722 46.976434116426,7.0873482128147 46.976476429094,7.0891771095176 46.976611164635,7.0895483299122 46.976634742659,7.0899208587358 46.976641614854,7.0902932565471 46.976628246195,7.0906608099029 46.97659435247,7.09102533867 46.976535374192,7.0913773764726 46.976454352233,7.0917195702298 46.976353453599,7.0920465173846 46.97623227969,7.0923007416217 46.976125535359,7.0970150672 46.97688615393,7.0981928083748 46.977071541943,7.1015265773118 46.977614057874,7.1054838784879 46.978251453413,7.112793007054 46.979421000214,7.1168669629548 46.980079270592,7.1315170723489 46.98245420486,7.1380799133832 46.983522583538,7.1465650915556 46.984900330967,7.1495279707786 46.979588412149,7.150708188614 46.977532980584))",
      projection: "EPSG:3857",
    },
    {
      id: "496",
      uri: "https://ld.geo.admin.ch/boundaries/municipality/496:2020",
      description: "Ins",
      wktGeometry:
        "POLYGON((7.0829947635692 47.013050949443,7.0829601669853 47.013111525419,7.0829968772648 47.013178080129,7.0835285409568 47.013561959634,7.0836312851699 47.013646518395,7.0837015471011 47.013745660819,7.0840509171954 47.01441547877,7.0841249260283 47.014510134957,7.0842835970276 47.014639965989,7.0848076332545 47.015044718232,7.0849499328249 47.015144791146,7.0855461753075 47.015518448914,7.0857092072975 47.015601257978,7.0880654502033 47.016706849361,7.0880283630189 47.016736577049,7.0882202945058 47.016848559193,7.0883539962542 47.016957776514,7.0886502957187 47.01722016174,7.088745962968 47.017313194564,7.0888310174465 47.017417641163,7.0890474763676 47.01781474199,7.0892009643313 47.018061745766,7.0893824605311 47.018305011944,7.0896011410313 47.018556880515,7.0898367312767 47.018797702476,7.0901288580662 47.019112692612,7.0903577418399 47.019417122433,7.0906164392426 47.019685740652,7.0937875995206 47.021652613844,7.0947495114557 47.022244119289,7.0949694102015 47.022417745749,7.0951675073747 47.022609386512,7.0953420649846 47.0228208355,7.095448558741 47.022813599288,7.0954482750216 47.022614446089,7.0955925262533 47.021991133611,7.0956120266975 47.021647678998,7.095639066482 47.020882442358,7.0956705323822 47.020962447334,7.0957338141024 47.021039736747,7.0958096118242 47.021111329252,7.0963007017077 47.021533863254,7.0965044949516 47.021701490527,7.0967276481469 47.021868107154,7.0968312153131 47.021937690636,7.0969168259812 47.021912411597,7.098023236945 47.020547709948,7.1002694212748 47.021508707924,7.1000309557943 47.021803503404,7.1025169108485 47.023266071974,7.1033231086162 47.022512061034,7.1034493592918 47.02238757879,7.1049854872072 47.020935118986,7.1050828473124 47.021039117011,7.1051604531598 47.021297301414,7.1055782316333 47.021763061799,7.1058463357048 47.022100890227,7.1063675334997 47.022481641039,7.1066469643526 47.022731134512,7.1072624473695 47.023253614612,7.1075596411491 47.023514232539,7.1074696838376 47.023649686019,7.1076214026479 47.023808428447,7.1084694673269 47.024283979593,7.108667046667 47.024152850101,7.1087647978841 47.024099633667,7.1092926239201 47.024243716981,7.1100336247268 47.024506842881,7.1107143170626 47.024759783908,7.1111748204732 47.025024762263,7.1113661049665 47.024991915602,7.1117307579907 47.024938437197,7.1119772825467 47.025326584398,7.1126366093223 47.025812887576,7.1125561177886 47.026158284398,7.1128475339533 47.026329606522,7.1131018761024 47.026492175772,7.1139795235273 47.026904028204,7.1139859392268 47.027133714348,7.1146735386435 47.027658270088,7.1150048573144 47.027917334646,7.1155064581623 47.02815696669,7.1157908606848 47.028490960574,7.116335919767 47.028048117168,7.1167567972205 47.027731887687,7.1171188449085 47.027427555923,7.1174484564857 47.027159674555,7.1177350968274 47.026935792682,7.1180721380506 47.026648163592,7.1183017071525 47.026472165431,7.1188266016047 47.026048019688,7.1194148488955 47.025592610508,7.1207551768799 47.026167546802,7.1214285981683 47.026452415095,7.1248984402861 47.027890268981,7.1254544157823 47.027276718811,7.1259188059804 47.026775433052,7.1260693165745 47.026620172973,7.1289457427644 47.027849662139,7.1296359021375 47.028140284174,7.1296882956254 47.028020239853,7.12983613034 47.027820228217,7.1299900967375 47.02757762984,7.1303566548376 47.027755249269,7.1314055999631 47.028244810071,7.1318524333968 47.028370322589,7.1332030036706 47.028730696599,7.1347903397079 47.028821909702,7.1364624918626 47.028806912945,7.1368788812162 47.028825733313,7.1374577532903 47.028841922073,7.138031714569 47.028851258714,7.1383214708466 47.028612210832,7.1384860450878 47.028395107693,7.1387940573083 47.027867464779,7.1388740655203 47.027640098398,7.1389117032603 47.027385365672,7.1390192647304 47.027003434247,7.1390354220734 47.026714238845,7.1390471940403 47.026142529231,7.1392501146632 47.025609324761,7.139622286274 47.025312751975,7.1402534998746 47.024891687559,7.1407810541368 47.024720379965,7.1410497787045 47.024643688279,7.1417007333788 47.024383128864,7.1405806527458 47.023956104911,7.1387314542741 47.023299605054,7.1377273676439 47.022934428914,7.1374239082888 47.022940387131,7.1369763647201 47.022955161849,7.1360155921334 47.022972692319,7.1350592128944 47.023001110503,7.1329126942576 47.022856122066,7.1318291827494 47.02267846602,7.1303211404116 47.022372824122,7.1301813416905 47.022664810867,7.1288370828118 47.022416946456,7.1278995797098 47.022075746462,7.1274757061745 47.021917268619,7.1271723654252 47.021779480422,7.1267767562869 47.021593450713,7.1256070895106 47.021061396224,7.1251968168928 47.02093004495,7.1247557294829 47.020796774826,7.12431893765 47.020651956069,7.1234565365307 47.020382639625,7.123849460279 47.019946289323,7.1239540710338 47.019762919332,7.1242762444493 47.019501912683,7.124363314559 47.019412875463,7.1246616742073 47.019421093936,7.125037643752 47.019355202343,7.1260347212878 47.019447705089,7.1261088225268 47.019323853663,7.1261759104009 47.019339385025,7.1263177496506 47.019206925886,7.1259147383505 47.019042135059,7.1261570700827 47.018700701816,7.1259548178105 47.018295131691,7.1256014820279 47.017914176423,7.1254874006782 47.017585631546,7.1256278018195 47.017462423025,7.1259458207444 47.017508797656,7.1262302116019 47.017328582061,7.1269814423717 47.017084008988,7.1272042390917 47.01700581895,7.127686152343 47.016630965918,7.1279000642279 47.016451667548,7.1282996417333 47.016072855049,7.1288610215976 47.015650639798,7.129968617501 47.014338604161,7.132408202772 47.015324523871,7.1324510796407 47.015263989072,7.1325587802176 47.015137198834,7.1326742195691 47.015013959802,7.1327982850793 47.014894330548,7.1329287583441 47.014778136451,7.1330667058569 47.014665740146,7.1332159065507 47.014560401199,7.1332096682373 47.014524336526,7.1329750921526 47.01449810694,7.1332193594974 47.014321465929,7.1329152817274 47.013926553496,7.133125858444 47.013707421714,7.1333200591025 47.013453873126,7.1330615804674 47.013195449097,7.1334602456831 47.012936993514,7.133703934925 47.013059033412,7.1340734590398 47.013225934154,7.1343880567816 47.013390787246,7.1348519482825 47.013748476112,7.1349007625492 47.013744614277,7.1350349714523 47.013910110347,7.1351911671394 47.01408608775,7.1354247867283 47.0139504091,7.1355259125661 47.013868113292,7.13563576835 47.013669645894,7.1357264655626 47.013608573261,7.1357602736333 47.013572232578,7.1362846478285 47.012617753167,7.1364035600054 47.01242151277,7.1367291056281 47.01210369815,7.1372726291025 47.011595906951,7.1375938198798 47.011270196375,7.1378690715519 47.010939664018,7.137875396766 47.010838046847,7.1365855752764 47.010335088263,7.1365258155323 47.010298353788,7.1353175665613 47.010030639504,7.1355264471244 47.009523474278,7.1357723069062 47.008958691571,7.136371741592 47.007468906522,7.1363161000662 47.00742247929,7.1363251424203 47.0073901994,7.135925989078 47.007341063553,7.1362833833594 47.005604057546,7.1357647133579 47.005665267559,7.1357562033674 47.005638383238,7.1359006349478 47.005589056582,7.1360016040441 47.005502498399,7.1361266130673 47.005373591653,7.136498804365 47.005051751845,7.1365798177036 47.004947656054,7.1365858807755 47.004930570055,7.1359743423851 47.004993098361,7.1356720086474 47.004977826124,7.1336345149778 47.004567117486,7.1344204831182 47.001733131018,7.1318490562146 47.001440872494,7.1321052287481 47.000542471547,7.1321802835229 47.000500463113,7.1320117495727 47.00052145313,7.1318602201329 47.000572138853,7.1317660485868 47.000465574414,7.1300287053106 47.001167352104,7.1297952482961 47.001256537935,7.1293421755916 47.001422712227,7.1289908813579 47.001541542488,7.1286367307254 47.001653842434,7.1282775794858 47.001760933,7.1279135192996 47.00186119526,7.1274932280251 47.001970388361,7.1275045674956 47.001874564582,7.1274795723472 47.001794833141,7.127488776501 47.001712901065,7.128245252464 46.999433066313,7.1282617867802 46.999370662316,7.1283085892218 46.999244013876,7.1285537851092 46.998501116933,7.1285452179822 46.998433888562,7.1284763195255 46.998386386975,7.1284945201339 46.998362453027,7.1285876014157 46.998374680483,7.1286638531633 46.998335938331,7.1291916324177 46.997839970207,7.1291669159414 46.997788653306,7.1291854299824 46.997764427754,7.1292839381523 46.9977560142,7.129343498063 46.997701844664,7.1299016092059 46.995334499598,7.1298253688277 46.995283943075,7.1298152801007 46.99524666456,7.13028915532 46.995188497769,7.1302693201544 46.995088676563,7.1319791467696 46.994877676217,7.1318495070519 46.994246474441,7.1319781432201 46.994190060308,7.132041810789 46.994149179497,7.1324891887462 46.992844179364,7.1325454917246 46.992631133427,7.1325322074513 46.992414055568,7.1324582353402 46.992010648699,7.1324477460717 46.991816369815,7.1324006226273 46.990070538639,7.132389739831 46.989913521143,7.1330110220919 46.988527746474,7.1362265665488 46.988457664887,7.1365316775864 46.988453513717,7.1366317389831 46.987459698712,7.1366351461668 46.987365539441,7.1366270405825 46.987273294933,7.1365379914187 46.98662013306,7.1366229818243 46.986633175962,7.1366533677828 46.986146347174,7.1380799133832 46.983522583538,7.1315170723489 46.98245420486,7.1168669629548 46.980079270592,7.112793007054 46.979421000214,7.1054838784879 46.978251453413,7.1015265773118 46.977614057874,7.0981928083748 46.977071541943,7.0970150672 46.97688615393,7.0923007416217 46.976125535359,7.0920465173846 46.97623227969,7.0917195702298 46.976353453599,7.0913773764726 46.976454352233,7.09102533867 46.976535374192,7.0906608099029 46.97659435247,7.0902932565471 46.976628246195,7.0899208587358 46.976641614854,7.0895483299122 46.976634742659,7.0891771095176 46.976611164635,7.0873482128147 46.976476429094,7.0869567138722 46.976434116426,7.0865661005322 46.976377142936,7.0861785587032 46.976312891458,7.0860525539487 46.976288215544,7.0577807667951 46.976874116391,7.0516752484396 46.97757352641,7.0512705868267 46.977670574541,7.0505530938972 46.977817202465,7.0405220556234 46.979774873434,7.0497668408629 46.984934042874,7.0497962231863 46.984940248354,7.0498980152161 46.984948780285,7.0499995883954 46.984978405189,7.0500408728714 46.985010905896,7.0500822285749 46.985033602033,7.0501652135283 46.985052639177,7.0501846620595 46.985085088097,7.0501667312395 46.985112923598,7.0501567889589 46.985151636742,7.0511721027056 46.98571812826,7.05703981586 46.988053734851,7.0600404586586 46.98932539424,7.0676665414687 46.992477248597,7.0739494014907 46.995185178372,7.0721070362094 46.99614978796,7.0793049860335 46.998148629098,7.0793321812628 46.998173732462,7.0795216738493 46.998225139574,7.079728578284 46.998265694383,7.0811319844276 46.998655435312,7.0785360700292 47.000641665131,7.0822916243833 47.002497874689,7.0787568117706 47.003466454037,7.0788702343455 47.003660229924,7.0774880873757 47.004038830022,7.0774434617664 47.003990205006,7.0772289921824 47.004049457513,7.0774365707833 47.004416802095,7.0775434404772 47.00447058234,7.0772769658618 47.004570834834,7.0771187820926 47.004774682644,7.0770268232381 47.004771535812,7.0768625571647 47.004775963407,7.0767053723956 47.004809973594,7.076567735726 47.004872391541,7.0762551008913 47.005060254657,7.0762619487343 47.005531904791,7.0767387067568 47.005980936419,7.07742926308 47.006173312264,7.0780300817089 47.006360104972,7.0780482491994 47.006459435281,7.0777355488652 47.006885415703,7.0780454895015 47.007222374779,7.0787712691904 47.006865990531,7.0789589714706 47.006564781933,7.0795424445649 47.006621408146,7.0810171777495 47.007603457927,7.0812499288019 47.007781446919,7.0814447917335 47.007979230106,7.0825315317957 47.009264342243,7.0826607777729 47.009445705065,7.0827527885716 47.009637464923,7.0828054182702 47.009835972183,7.0829471917834 47.010709574137,7.0829904863351 47.010917935658,7.0830504482369 47.011124100205,7.083242287956 47.011695563573,7.0832925138974 47.011793755735,7.0833714392478 47.011882524678,7.083557132579 47.011922275521,7.0835049179016 47.01208883867,7.0834619582771 47.012146454154,7.0833780648052 47.012374917969,7.0829947635692 47.013050949443))",
      projection: "EPSG:3857",
    },
  ];
  res.status(200).json({
    message: "Features fetched successfully !",
    features: features,
  });
});

module.exports = app;
